
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Task Arrays for Data Parallelism &#8212; CIP201 - Mastering the Alliance&#39;s Compute Systems</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '3-task-arrays';</script>
    <link rel="icon" href="_static/logo.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Storage Spaces" href="4-storage.html" />
    <link rel="prev" title="Use Resources Wisely" href="2-resources.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="0-about.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="CIP201 - Mastering the Alliance's Compute Systems - Home"/>
    <img src="_static/logo.png" class="logo__image only-dark pst-js-only" alt="CIP201 - Mastering the Alliance's Compute Systems - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="0-about.html">
                    Mastering the Alliance’s Compute Systems
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1-introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="2-resources.html">Use Resources Wisely</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Task Arrays for Data Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="4-storage.html">Storage Spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="90-exercises.html">Additional Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="99-references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/calculquebec/cip201-compute-systems" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/3-task-arrays.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Task Arrays for Data Parallelism</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gnu-parallel">GNU Parallel</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-not-slurm">Why Not Slurm?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gnu-parallel-command-syntax">GNU Parallel Command Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-sequence-of-parameter-values">One Sequence of Parameter Values</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-combinations-of-parameter-values">Multiple Combinations of Parameter Values</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#limiting-the-number-of-simultaneous-processes">Limiting the Number of Simultaneous Processes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-aligning-dna-sequences"><strong>Exercise</strong> - Aligning DNA Sequences</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-tools">Other Tools</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#job-arrays">Job Arrays</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-job-arrays"><strong>Exercise</strong> - Job Arrays</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-points">Key Points</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="task-arrays-for-data-parallelism">
<h1>Task Arrays for Data Parallelism<a class="headerlink" href="#task-arrays-for-data-parallelism" title="Link to this heading">#</a></h1>
<p>While high performance computing is usually designed for
task parallelism, it can also be used to run multiple
serial tasks simultaneously for data parallelism.
This chapter will present useful tools to manage a large number of
compute tasks when the research project requires hundreds of results.</p>
<section id="gnu-parallel">
<h2>GNU Parallel<a class="headerlink" href="#gnu-parallel" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://docs.alliancecan.ca/wiki/GNU_Parallel">GNU <code class="docutils literal notranslate"><span class="pre">parallel</span></code> command</a>
allows to fully use the resources on a compute node by managing
the execution of a <strong>long list of <em>small</em> compute tasks</strong>.
This is like the Slurm scheduler, but at a smaller
scale and by managing processes instead of job scripts.</p>
<p><img alt="GNU Parallel workflow" src="_images/gnu-parallel.svg" /></p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.gnu.org/software/parallel/parallel.html">Official documentation</a></p></li>
<li><p><a class="reference external" href="https://www.gnu.org/software/parallel/parallel_tutorial.html">Tutorial</a></p></li>
</ul>
<section id="why-not-slurm">
<h3>Why Not Slurm?<a class="headerlink" href="#why-not-slurm" title="Link to this heading">#</a></h3>
<p>Why not simply submit <strong>hundreds of jobs to Slurm</strong>?</p>
<ul class="simple">
<li><p>At anytime, Slurm <strong>limits each user to 1000 jobs</strong>
in its queue (including <em>pending</em> and <em>running</em> jobs)</p></li>
<li><p>Certain compute tasks are so <strong>short (&lt; 5 minutes)</strong>
that the time to properly start and end these tasks
individually would significantly reduce their global efficiency</p></li>
</ul>
<p>GNU Parallel advantages:</p>
<ul class="simple">
<li><p><strong>No need of using a loop</strong>, which makes
it easier to manage hundreds of compute tasks</p></li>
<li><p>The number of <strong>available CPU cores automatically limits</strong>
the number of simultaneous running tasks</p>
<ul>
<li><p>For a set of parallel tasks, it is possible to specify
a smaller number of processes than the number of CPU cores</p></li>
</ul>
</li>
<li><p>GNU Parallel can
<a class="reference external" href="https://docs.alliancecan.ca/wiki/GNU_Parallel#Keeping_Track_of_Completed_and_Failed_Commands,_and_Restart_Capabilities">resume the sequence of compute tasks</a>
in case of a job ending sooner than expected or what is needed</p></li>
</ul>
</section>
<section id="gnu-parallel-command-syntax">
<h3>GNU Parallel Command Syntax<a class="headerlink" href="#gnu-parallel-command-syntax" title="Link to this heading">#</a></h3>
<p>The main basic elements of a <code class="docutils literal notranslate"><span class="pre">parallel</span></code> command are:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>parallel<span class="w"> </span>options<span class="w"> </span>command_template<span class="w"> </span>:::<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>values
</pre></div>
</div>
<p>See the manual page:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>man<span class="w"> </span>parallel<span class="w">  </span><span class="c1"># Press Q to quit</span>
</pre></div>
</div>
</section>
<section id="use-cases">
<h3>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h3>
<section id="one-sequence-of-parameter-values">
<h4>One Sequence of Parameter Values<a class="headerlink" href="#one-sequence-of-parameter-values" title="Link to this heading">#</a></h4>
<p>The default placeholder for the changing parameter is <code class="docutils literal notranslate"><span class="pre">{}</span></code>:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>parallel<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file<span class="o">{}</span>.txt<span class="w"> </span>:::<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">4</span>
<span class="c1"># parallel --citation  # Commit to citing developers</span>
</pre></div>
</div>
<p>We can rewrite the above command by using the Bash expansion <code class="docutils literal notranslate"><span class="pre">{a..b}</span></code>:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>parallel<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file<span class="o">{}</span>.txt<span class="w"> </span>:::<span class="w"> </span><span class="o">{</span><span class="m">1</span>..4<span class="o">}</span>
parallel<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file<span class="o">{}</span>.txt<span class="w"> </span>:::<span class="w"> </span><span class="o">{</span><span class="m">01</span>..10<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="multiple-combinations-of-parameter-values">
<h4>Multiple Combinations of Parameter Values<a class="headerlink" href="#multiple-combinations-of-parameter-values" title="Link to this heading">#</a></h4>
<p><strong>a)</strong> When you have <strong>multiple sequences of parameters to combine</strong>,
you can use numbered placeholders, like <code class="docutils literal notranslate"><span class="pre">{1}</span></code> and <code class="docutils literal notranslate"><span class="pre">{2}</span></code>:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>parallel<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>file<span class="o">{</span><span class="m">1</span><span class="o">}{</span><span class="m">2</span><span class="o">}</span>.txt<span class="w"> </span>:::<span class="w"> </span><span class="o">{</span><span class="m">01</span>..10<span class="o">}</span><span class="w"> </span>:::<span class="w"> </span>a<span class="w"> </span>b
</pre></div>
</div>
<p><strong>b)</strong> In the case where <strong>all combinations
of parameters are in a text file</strong>:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>scripts/param.txt
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">parallel</span></code> command will have <code class="docutils literal notranslate"><span class="pre">-C</span> <span class="pre">'</span> <span class="pre">'</span></code> to specify
the separator between parameters in <code class="docutils literal notranslate"><span class="pre">scripts/param.txt</span></code>,
and the <code class="docutils literal notranslate"><span class="pre">::::</span></code> argument to provide this filename:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># parallel -C &#39; &#39; echo &#39;$(({1}*{2}))&#39; :::: scripts/param.txt</span>
cat<span class="w"> </span>scripts/prll-exec-param.sh
sbatch<span class="w"> </span>scripts/prll-exec-param.sh
</pre></div>
</div>
<p><strong>c)</strong> If you prefer to validate a <strong>list of commands in a
text file</strong> prior to their execution on the compute node:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>scripts/cmd.txt
</pre></div>
</div>
<p>The job script will have a much simplified <code class="docutils literal notranslate"><span class="pre">parallel</span></code> command:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># parallel &lt; scripts/cmd.txt</span>
cat<span class="w"> </span>scripts/prll-exec-cmd.sh
sbatch<span class="w"> </span>scripts/prll-exec-cmd.sh
</pre></div>
</div>
</section>
<section id="limiting-the-number-of-simultaneous-processes">
<h4>Limiting the Number of Simultaneous Processes<a class="headerlink" href="#limiting-the-number-of-simultaneous-processes" title="Link to this heading">#</a></h4>
<p>The flag <code class="docutils literal notranslate"><span class="pre">--jobs</span></code> allows us to limit the number of
simultaneous running processes. For example, we can
have 8 tasks done with 2 simultaneous processes:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>parallel<span class="w"> </span>--jobs<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s1">&#39;echo {} &amp;&amp; sleep 3&#39;</span><span class="w"> </span>:::<span class="w"> </span><span class="o">{</span><span class="m">1</span>..8<span class="o">}</span>
</pre></div>
</div>
</section>
</section>
<section id="exercise-aligning-dna-sequences">
<h3><strong>Exercise</strong> - Aligning DNA Sequences<a class="headerlink" href="#exercise-aligning-dna-sequences" title="Link to this heading">#</a></h3>
<p>In the directory <code class="docutils literal notranslate"><span class="pre">data/</span></code>, you should already have multiple
Fasta files (<code class="docutils literal notranslate"><span class="pre">*.fa</span></code>) that were created in the previous
chapter with the job script <code class="docutils literal notranslate"><span class="pre">scripts/blastn-gen-seq.sh</span></code>.
<strong>If this is not the case</strong>, run the following:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>sbatch<span class="w"> </span>scripts/blastn-gen-seq.sh
</pre></div>
</div>
<p>You should find:</p>
<ul class="simple">
<li><p>for each fictive species A, B, C and D,
a file of “known” DNA sequences</p>
<ul>
<li><p>These files are converted into a Blast database</p></li>
</ul>
</li>
<li><p>for 16 “unknown” species K through Z, DNA sequences
to align on “known” sequences of species A through D</p></li>
</ul>
<p>We then want to compute the alignement of all
combinations <code class="docutils literal notranslate"><span class="pre">{A,B,C,D}</span></code> x <code class="docutils literal notranslate"><span class="pre">{K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z}</span></code>,
which makes 64 combinations to test.
The following job script uses GNU Parallel in order
to compute all combinations with 4 CPU cores:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>scripts/blastn-parallel.sh
sbatch<span class="w"> </span>scripts/blastn-parallel.sh
</pre></div>
</div>
<p>To monitor the status of the compute job:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>squeue<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span>
ls<span class="w"> </span>data/res_prll/
</pre></div>
</div>
<p>At the end of the job, check used resources:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">seff</span> <span class="o">&lt;</span><span class="n">job_id</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="other-tools">
<h3>Other Tools<a class="headerlink" href="#other-tools" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>GLOST
<a class="reference external" href="https://docs.alliancecan.ca/wiki/GLOST">for serial tasks only</a></p></li>
<li><p>META-Farm
<a class="reference external" href="https://docs.alliancecan.ca/wiki/META-Farm">for the best of GNU Parallel and GLOST</a></p></li>
</ul>
<p>While the above tools can be useful with a set of serial tasks or
small parallel tasks (16 cores or less), <strong>they are not appropriate
for long and large parallel jobs</strong> (more than 16 cores per task):</p>
<ol class="arabic simple">
<li><p>we want to avoid jobs longer than 3 days, and</p></li>
<li><p>we want to reduce the risk of being affected by a defective node.</p></li>
</ol>
<p>That is why, in some cases, it is better to use job arrays.</p>
</section>
</section>
<section id="job-arrays">
<h2>Job Arrays<a class="headerlink" href="#job-arrays" title="Link to this heading">#</a></h2>
<p>In the case where a single program must be executed with
different combinations of parameters, it is possible to submit
a <a class="reference external" href="https://docs.alliancecan.ca/wiki/Job_arrays">job array</a>
and write the job script such that parameters will be derived
<strong>in function of one unique integer value</strong> of the job array.</p>
<p><img alt="How Job Arrays Work" src="_images/job-arrays.svg" /></p>
<p><strong>To submit a job array</strong> to the Slurm scheduler, <strong>we must
add the option</strong> <code class="docutils literal notranslate"><span class="pre">--array=&lt;integers&gt;</span></code> to the <code class="docutils literal notranslate"><span class="pre">#SBATCH</span></code> header.
See <a class="reference external" href="https://docs.alliancecan.ca/wiki/Job_arrays">some examples here</a>.</p>
<p>A job ID in a job array contains:</p>
<ul class="simple">
<li><p>The ID of the job array</p></li>
<li><p>The underscore character (<code class="docutils literal notranslate"><span class="pre">_</span></code>)</p></li>
<li><p>The unique integer associated to that job</p></li>
</ul>
<p><strong>For example:</strong> <code class="docutils literal notranslate"><span class="pre">25249551_15</span></code></p>
<p>In the job script, the <strong>environment variable</strong>
<code class="docutils literal notranslate"><span class="pre">$SLURM_ARRAY_TASK_ID</span></code> can be used to retrieve the
unique integer associated to the current running job.
It is one of the specified <code class="docutils literal notranslate"><span class="pre">&lt;integers&gt;</span></code> in the header.</p>
<p>The variable <code class="docutils literal notranslate"><span class="pre">$SLURM_ARRAY_TASK_ID</span></code> can be used in many ways.
The below examples use <code class="docutils literal notranslate"><span class="pre">$N</span></code>, but <code class="docutils literal notranslate"><span class="pre">$SLURM_ARRAY_TASK_ID</span></code>
works the same in a job script:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">N</span><span class="o">=</span><span class="m">71</span><span class="w">  </span><span class="c1"># Only required for this example</span>

<span class="nb">echo</span><span class="w"> </span>file.<span class="nv">$N</span>
<span class="nb">echo</span><span class="w"> </span>directory-<span class="nv">$N</span>
</pre></div>
</div>
<p><img alt="From One Integer to 2D Coordinates" src="_images/n2r_c.svg" /></p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PARAM_R</span><span class="o">=</span><span class="k">$((</span><span class="nv">N</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">12</span><span class="k">))</span><span class="w">  </span><span class="c1"># Integer division</span>
<span class="nv">PARAM_C</span><span class="o">=</span><span class="k">$((</span><span class="nv">N</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="m">12</span><span class="k">))</span><span class="w">  </span><span class="c1"># Modulo (division remainder)</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$PARAM_R</span><span class="w"> </span><span class="nv">$PARAM_C</span>

head<span class="w"> </span>-n<span class="w"> </span><span class="k">$((</span><span class="nv">PARAM_R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="w"> </span>scripts/param.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1
</pre></div>
</div>
<section id="exercise-job-arrays">
<h3><strong>Exercise</strong> - Job Arrays<a class="headerlink" href="#exercise-job-arrays" title="Link to this heading">#</a></h3>
<p>Submit the job array:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>scripts/blastn-array.sh
sbatch<span class="w"> </span>scripts/blastn-array.sh

squeue<span class="w"> </span>-u<span class="w"> </span><span class="nv">$USER</span>
</pre></div>
</div>
<p>Once all four jobs are done, inspect the results:</p>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>ls<span class="w"> </span>slurm-*_*.out
ls<span class="w"> </span>-l<span class="w"> </span>data/res_array/
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Modify the job script</strong> to process all 16 unknowns K through Z,
with a limit of <strong>four</strong> simultaneous processes per job</p></li>
<li><p>Submit this modified job array</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">seff</span></code> command to investigate one of the 16 jobs</p></li>
</ul>
</section>
</section>
<section id="key-points">
<h2>Key Points<a class="headerlink" href="#key-points" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>GNU Parallel</strong>
<a class="reference external" href="https://docs.alliancecan.ca/wiki/GNU_Parallel">to run multiple combinations of parameters</a></p></li>
</ul>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span>parallel<span class="w"> </span><span class="s1">&#39;command_template({1})&#39;</span><span class="w"> </span>:::<span class="w"> </span>values1
parallel<span class="w"> </span><span class="s1">&#39;command_template({1}, {2})&#39;</span><span class="w"> </span>:::<span class="w"> </span>values1<span class="w"> </span>:::<span class="w"> </span>values2
parallel<span class="w"> </span>-C<span class="w"> </span>&lt;sep&gt;<span class="w"> </span><span class="s1">&#39;command_template({1}, {2})&#39;</span><span class="w"> </span>::::<span class="w"> </span>param_pairs.txt
parallel<span class="w"> </span>--jobs<span class="w"> </span><span class="s1">&#39;N_processes_per_node&#39;</span><span class="w"> </span>&lt;<span class="w"> </span>command_list.txt
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Job Arrays</strong>
<a class="reference external" href="https://docs.alliancecan.ca/wiki/Job_arrays">to submit many long or large similar jobs</a></p></li>
</ul>
<div class="highlight-Bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># $SLURM_ARRAY_TASK_ID will have only one value of ...</span>
sbatch<span class="w"> </span>--array<span class="o">=</span><span class="m">0</span>-7<span class="w">      </span><span class="c1"># [0, 7]</span>
sbatch<span class="w"> </span>--array<span class="o">=</span><span class="m">1</span>,3,5,7<span class="w">  </span><span class="c1"># {1,3,5,7}</span>
sbatch<span class="w"> </span>--array<span class="o">=</span><span class="m">1</span>-7:3<span class="w">    </span><span class="c1"># {1,4,7}</span>
sbatch<span class="w"> </span>--array<span class="o">=</span><span class="m">0</span>-99%10<span class="w">  </span><span class="c1"># [0, 99], but maximum 10 simultaneous jobs</span>
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="2-resources.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Use Resources Wisely</p>
      </div>
    </a>
    <a class="right-next"
       href="4-storage.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Storage Spaces</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gnu-parallel">GNU Parallel</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-not-slurm">Why Not Slurm?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gnu-parallel-command-syntax">GNU Parallel Command Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-sequence-of-parameter-values">One Sequence of Parameter Values</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-combinations-of-parameter-values">Multiple Combinations of Parameter Values</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#limiting-the-number-of-simultaneous-processes">Limiting the Number of Simultaneous Processes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-aligning-dna-sequences"><strong>Exercise</strong> - Aligning DNA Sequences</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-tools">Other Tools</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#job-arrays">Job Arrays</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-job-arrays"><strong>Exercise</strong> - Job Arrays</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-points">Key Points</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Calcul Québec Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>